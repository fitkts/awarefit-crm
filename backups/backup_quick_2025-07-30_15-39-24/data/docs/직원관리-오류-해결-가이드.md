# 직원관리 시스템 오류 해결 가이드

## 📋 목차
1. [발생한 문제 개요](#발생한-문제-개요)
2. [문제 1: 마이그레이션 실패](#문제-1-마이그레이션-실패)
3. [문제 2: IPC 핸들러 중복 등록](#문제-2-ipc-핸들러-중복-등록)
4. [해결 과정 및 방법](#해결-과정-및-방법)
5. [예방 방법](#예방-방법)
6. [참고 자료](#참고-자료)

---

## 발생한 문제 개요

직원관리 시스템 구현 후 `npm run dev` 실행 시 다음과 같은 오류들이 발생했습니다:

### 주요 오류 로그
```
[1] 마이그레이션 실패: 2_expand_staff_management SqliteError: duplicate column name: birth_date
[1] Error: Attempted to register a second handler for 'staff-get-all'
[1] Error: Attempted to register a second handler for 'member-get-all'
[1] SqliteError: no such table: staff_roles
```

---

## 문제 1: 마이그레이션 실패

### 🚨 오류 상황
```
마이그레이션 실패: 2_expand_staff_management SqliteError: duplicate column name: birth_date
```

### 원인 분석
1. **SQLite 제약사항**: SQLite는 `ALTER TABLE ADD COLUMN IF NOT EXISTS` 구문을 지원하지 않음
2. **컬럼 중복**: `birth_date` 컬럼이 이미 존재하는 상태에서 다시 생성 시도
3. **트랜잭션 실패**: 하나의 컬럼 생성 실패로 전체 마이그레이션이 롤백됨

### 해결 방법

#### 1. 마이그레이션 러너 개선
```typescript
// src/database/migrations/migrationRunner.ts
private executeSQLSafely(sql: string, migrationName: string): void {
  const hasTransaction = sql.includes('BEGIN TRANSACTION') || sql.includes('BEGIN;');
  
  if (hasTransaction) {
    try {
      this.db.exec(sql);
    } catch (error: any) {
      // 컬럼 중복 생성 에러는 무시하고 계속 진행
      if (error.code === 'SQLITE_ERROR' && 
          (error.message.includes('duplicate column name') || 
           error.message.includes('already exists'))) {
        console.log(`컬럼이 이미 존재합니다 (무시): ${error.message}`);
        
        // 트랜잭션 롤백 후 성공적인 부분만 실행
        try {
          this.db.exec('ROLLBACK;');
        } catch (rollbackError) {
          // 롤백 에러는 무시
        }
        
        // 테이블 생성과 데이터 삽입만 개별적으로 실행
        this.executeNonConflictingStatements(sql);
        return;
      }
      
      // 치명적 에러만 중단
      if (error.code === 'SQLITE_ERROR' && 
          error.message.includes('syntax error')) {
        throw error;
      }
    }
  }
}
```

#### 2. 안전한 마이그레이션 전략
```sql
-- 기존 방식 (문제 발생)
ALTER TABLE staff ADD COLUMN birth_date DATE;

-- 개선된 방식 (에러 처리 포함)
-- 마이그레이션 러너가 컬럼 중복 에러를 자동으로 처리
ALTER TABLE staff ADD COLUMN birth_date DATE;
ALTER TABLE staff ADD COLUMN address TEXT;
ALTER TABLE staff ADD COLUMN salary DECIMAL(10,2);
-- ... 기타 컬럼들
```

---

## 문제 2: IPC 핸들러 중복 등록

### 🚨 오류 상황
```
Error: Attempted to register a second handler for 'staff-get-all'
Error: Attempted to register a second handler for 'member-get-all'
```

### 원인 분석
1. **중복 등록**: `systemHandlers.ts`와 `staffHandlers.ts`에서 같은 핸들러 등록
2. **에러 처리 로직 문제**: main.ts에서 에러 발생 시 핸들러를 두 번 등록
3. **책임 분리 미흡**: 시스템 핸들러에 도메인별 핸들러가 섞여 있음

### 해결 방법

#### 1. 중복 핸들러 제거
```typescript
// src/main/ipc/systemHandlers.ts (수정 전)
export const registerSystemHandlers = (): void => {
  // ... 시스템 관련 핸들러들
  
  // ❌ 중복 등록 (staffHandlers.ts에서도 등록됨)
  ipcMain.handle('staff-get-all', async () => {
    // ...
  });
  
  ipcMain.handle('staff-get-by-id', async (_, id) => {
    // ...
  });
  
  ipcMain.handle('staff-create', async (_, data) => {
    // ...
  });
}

// src/main/ipc/systemHandlers.ts (수정 후)
export const registerSystemHandlers = (): void => {
  // ✅ 시스템 관련 핸들러만 유지
  ipcMain.handle('app-version', () => {
    return app.getVersion();
  });
  
  ipcMain.handle('database-query', async (_, sql, params = []) => {
    // ...
  });
  
  // 직원 관련 핸들러 제거 (staffHandlers.ts에서 관리)
}
```

#### 2. main.ts 에러 처리 개선
```typescript
// src/main/main.ts (수정 전)
app.whenReady().then(async () => {
  try {
    await initializeDatabase();
    registerMemberHandlers();
    registerPaymentHandlers();
    registerStaffHandlers();
    registerSystemHandlers();
  } catch (error) {
    console.error('앱 초기화 실패:', error);
    // ❌ 에러 발생해도 핸들러를 다시 등록 (중복 발생)
    registerMemberHandlers();
    registerPaymentHandlers();
    registerStaffHandlers();
    registerSystemHandlers();
  }
});

// src/main/main.ts (수정 후)
app.whenReady().then(() => {
  try {
    // 데이터베이스 초기화 (동기적으로 처리)
    initializeDatabase();
    console.log('데이터베이스 초기화 완료');
  } catch (error) {
    console.error('데이터베이스 초기화 실패:', error);
    console.log('마이그레이션 실패했지만 앱은 계속 실행됩니다.');
  }

  // ✅ IPC 핸들러 등록 (한 번만 실행)
  try {
    registerSystemHandlers();
    registerMemberHandlers();
    registerPaymentHandlers();
    registerStaffHandlers();
    console.log('IPC 핸들러 등록 완료');
  } catch (error) {
    console.error('IPC 핸들러 등록 실패:', error);
  }
});
```

---

## 해결 과정 및 방법

### 1단계: 문제 진단
```bash
# 1. 기존 데이터베이스 파일 삭제
rm -f ~/Library/Application\ Support/Electron/awarefit.db

# 2. 로그 분석
npm run dev
# 오류 메시지 확인 및 원인 파악
```

### 2단계: 마이그레이션 시스템 개선
- SQLite 호환성을 고려한 안전한 에러 처리
- 컬럼 중복 생성 에러를 무시하고 계속 진행
- 성공적인 부분만 선별적으로 실행

### 3단계: IPC 핸들러 정리
- 도메인별 책임 분리 (시스템 vs 직원 vs 회원 vs 결제)
- 중복 등록 방지
- 에러 처리 로직 개선

### 4단계: 검증
```bash
npm run dev
# ✅ 마이그레이션 성공
# ✅ IPC 핸들러 등록 완료
# ✅ 애플리케이션 정상 실행
```

---

## 예방 방법

### 1. 마이그레이션 작성 시 주의사항

#### ✅ 권장사항
```sql
-- 1. 테이블 생성을 먼저 수행
CREATE TABLE IF NOT EXISTS staff_roles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE NOT NULL,
  permissions TEXT NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. 컬럼 추가 (마이그레이션 러너가 중복 에러 처리)
ALTER TABLE staff ADD COLUMN gender TEXT CHECK(gender IN ('남성', '여성'));
ALTER TABLE staff ADD COLUMN birth_date DATE;
ALTER TABLE staff ADD COLUMN address TEXT;

-- 3. 인덱스 생성
CREATE INDEX IF NOT EXISTS idx_staff_active ON staff(is_active);

-- 4. 데이터 삽입
INSERT OR IGNORE INTO staff_roles (name, permissions, description) VALUES 
  ('관리자', '{"member_management":true}', '모든 권한을 가진 관리자');
```

#### ❌ 피해야 할 사항
```sql
-- SQLite에서 지원하지 않는 구문
ALTER TABLE staff ADD COLUMN IF NOT EXISTS birth_date DATE;

-- 트랜잭션 없이 여러 작업을 수행하면 일부만 실행될 위험
ALTER TABLE staff ADD COLUMN birth_date DATE;
CREATE TABLE staff_roles (...);
INSERT INTO staff_roles (...);
```

### 2. IPC 핸들러 관리

#### ✅ 권장 구조
```
src/main/ipc/
├── systemHandlers.ts    // 시스템 관련 (앱 버전, 백업/복원 등)
├── memberHandlers.ts    // 회원 관련 (CRUD, 검색 등)
├── staffHandlers.ts     // 직원 관련 (CRUD, 역할, 급여 등)
└── paymentHandlers.ts   // 결제 관련 (CRUD, 통계 등)
```

#### ✅ 명명 규칙
```typescript
// 도메인-동작 패턴 사용
ipcMain.handle('staff-get-all', ...);
ipcMain.handle('staff-create', ...);
ipcMain.handle('staff-salary-adjust', ...);
ipcMain.handle('member-get-all', ...);
ipcMain.handle('payment-create', ...);
```

#### ❌ 피해야 할 사항
```typescript
// 같은 핸들러를 여러 파일에서 등록
// systemHandlers.ts
ipcMain.handle('staff-get-all', ...);

// staffHandlers.ts  
ipcMain.handle('staff-get-all', ...); // ❌ 중복!
```

### 3. 에러 처리 패턴

#### ✅ 권장 패턴
```typescript
// 각 단계별로 별도 에러 처리
try {
  initializeDatabase();
} catch (error) {
  console.error('데이터베이스 초기화 실패:', error);
  // 계속 진행 (복구 가능한 오류)
}

try {
  registerHandlers();
} catch (error) {
  console.error('핸들러 등록 실패:', error);
  // 별도 처리 (재시도하지 않음)
}
```

#### ❌ 피해야 할 패턴
```typescript
// 에러 발생 시 모든 작업을 재시도
try {
  initializeDatabase();
  registerHandlers();
} catch (error) {
  // ❌ 핸들러까지 다시 등록하면 중복 발생
  initializeDatabase();
  registerHandlers();
}
```

---

## 참고 자료

### SQLite 제약사항
- [SQLite ALTER TABLE 문서](https://www.sqlite.org/lang_altertable.html)
- SQLite는 `ADD COLUMN IF NOT EXISTS` 지원하지 않음
- 컬럼 삭제, 이름 변경 등 제한적 지원

### Electron IPC 핸들러
- [Electron IPC 문서](https://www.electronjs.org/docs/latest/tutorial/ipc)
- 핸들러는 한 번만 등록해야 함
- 중복 등록 시 오류 발생

### 개발 팁
1. **점진적 개발**: 한 번에 모든 기능을 구현하지 말고 단계별로 진행
2. **테스트 환경**: 개발 시 데이터베이스 파일을 주기적으로 삭제하고 재생성
3. **로그 모니터링**: 개발 도구의 콘솔에서 오류 로그를 실시간 확인
4. **백업 전략**: 중요한 변경 전에는 항상 데이터베이스 백업

### 관련 파일
- `src/database/migrations/migrationRunner.ts` - 마이그레이션 실행 로직
- `src/main/main.ts` - 애플리케이션 초기화
- `src/main/ipc/` - IPC 핸들러들
- `docs/직원관리-구현-가이드.md` - 구현 가이드

---

## 🎯 핵심 교훈

1. **SQLite 특성 이해**: PostgreSQL, MySQL과 다른 제약사항 숙지
2. **점진적 개발**: 복잡한 기능은 단계별로 구현하고 테스트
3. **책임 분리**: 각 모듈의 역할을 명확히 구분
4. **에러 처리**: 복구 가능한 오류와 치명적 오류를 구분하여 처리
5. **문서화**: 발생한 문제와 해결 방법을 기록하여 재발 방지

이러한 경험을 바탕으로 앞으로는 더 안정적이고 확장 가능한 시스템을 구축할 수 있을 것입니다! 🚀 