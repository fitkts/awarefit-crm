# 결제관리 시스템 구현 가이드

## 📋 목차

1. [개요](#개요)
2. [요구사항 분석](#요구사항-분석)
3. [단계별 구현 프롬프트](#단계별-구현-프롬프트)
4. [오류 방지 체크리스트](#오류-방지-체크리스트)
5. [문제 해결 가이드](#문제-해결-가이드)

## 개요

이 가이드는 Awarefit CRM 시스템에 결제관리 기능을 안전하고 체계적으로 구현하기
위한 프롬프트 모음입니다. 기존 회원관리 및 직원관리 시스템을 참조하여 일관성
있는 구조로 개발할 수 있도록 설계되었습니다.

### 🎯 구현 목표

- 회원/직원관리와 동일한 UX/UI 패턴
- 다양한 결제 유형 및 방식 지원
- 결제 이력 및 통계 관리
- 환불 및 부분 결제 처리
- 회원-직원-결제 연동 기능
- 완전한 CRUD 작업 지원

## 요구사항 분석

### 📝 사용자 답변 기록 ✅

**결제 유형:**

- [x] 회원권 결제 (1개월/3개월/12개월) ⭐ 1순위
- [x] 피티 결제 (횟수제: 5회/10회/20회) ⭐ 1순위
- [x] 부가 서비스 (개인락커) ⭐ 1순위
- [ ] 기타 상품 판매 (추후 고려)

**결제 방식:**

- [x] 현금 ⭐ 1순위 구현
- [x] 카드 📅 2순위 구현
- [x] 계좌이체 📅 3순위 구현
- [x] 온라인 결제 📅 4순위 구현

**핵심 기능:**

- [x] 환불 처리 ⭐ 필수
- [ ] 할부 결제 (추후 고려)
- [ ] 부분 결제 (추후 고려)
- [ ] 자동 결제 (추후 고려)
- [ ] 연체 관리 (추후 고려)

**연동 요구사항:**

- [x] 회원별 결제 이력 ⭐ 필수
- [x] 담당 직원별 매출 ⭐ 필수
- [x] 통계 및 리포트 ⭐ 필수

**금융 데이터 처리:**

- [x] 원화(KRW) 기준
- [x] 정수형 원 단위 저장 (소수점 불필요)
- [x] 금액 포맷팅: 천 단위 콤마 표시

**정기 결제 및 만료 관리:**

- [x] 월회비: 수동 결제 방식
- [x] 락커비: 월단위 관리
- [x] 만료일 자동 알림 시스템
- [x] 결제 예정일 3일전 알림

**환불 및 권한 관리:**

- [x] 환불 승인: 관리자 권한만 (staff.can_manage_payments = 1)
- [x] 환불 규칙: 커스텀 설정 가능 (금액/기간별 제한)
- [x] 환불 방식: 계좌이체, 카드 취소, 현금
- [x] 기타 기능: 제한 없음 (결제 등록, 조회, 통계)

**통계 및 리포트:**

- [x] 매출 현황 (일별/월별/연별)
- [x] 직원별 매출 실적 (staff_id 기준)
- [x] 결제 유형별 분석 (회원권/피티/락커)
- [x] 환불률 및 손실 분석

**데이터 보관 및 히스토리:**

- [x] 결제/환불 이력: 영구 보관
- [x] 통계 데이터: 월별 요약본 생성
- [x] 삭제 회원 결제 이력: 백업 보관
- [x] 데이터 백업: 일별 실행 (설정 변경 가능)

**초기 설정 및 기존 데이터:**

- [x] 기존 수기 관리 데이터 있음 (마이그레이션 필요)
- [x] 회원권 종류: 1개월/3개월/12개월권
- [x] 피티 종류: 5회/10회/20회 (횟수제)
- [x] 락커 요금: 고정 요금제
- [x] 기본 설정값: 없음 (유연한 설정)
- [x] 수수료 설정: 카드사별, 부가세 등 설정 가능

## 📊 데이터베이스 스키마 설계

### 🔍 **기존 시스템 분석**

#### ✅ **기존 테이블 구조 (수정 불필요)**

- **members**: id(INTEGER), member_number, name, phone, email, gender,
  birth_date, join_date, active
- **staff**: id(INTEGER), staff_number, name, position, hire_date, is_active,
  can_manage_payments
- **payments**: 이미 존재 (확장 필요)
- **pt_sessions**: 이미 존재 (구조 개선 필요)

### 🗂️ **수정 및 신규 테이블 구조**

#### 1. PAYMENTS 테이블 확장 ⚠️ **기존 테이블 수정**

```sql
-- 기존 payments 테이블에 락커 결제 지원을 위한 컬럼 추가
ALTER TABLE payments ADD COLUMN locker_type TEXT; -- 'individual', 'couple', etc.
ALTER TABLE payments ADD COLUMN expiry_date DATE; -- 회원권/락커 만료일
ALTER TABLE payments ADD COLUMN auto_renewal BOOLEAN DEFAULT 0; -- 자동 갱신 여부

-- 기존 payment_method 제약조건 확장 (카드/계좌이체/온라인 추가)
-- 기존: ('현금', '카드', '계좌이체', '기타')
-- 확장: ('현금', '카드', '계좌이체', '온라인결제', '기타')
```

#### 2. PAYMENT_ITEMS 테이블 신규 생성 ⭐

```sql
CREATE TABLE IF NOT EXISTS payment_items (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  payment_id INTEGER NOT NULL,
  item_type TEXT NOT NULL, -- 'membership', 'pt', 'locker'
  item_subtype TEXT, -- '1m', '3m', '12m' or '5sessions', '10sessions', '20sessions'
  item_name TEXT NOT NULL, -- '1개월 회원권', '10회 피티', '개인 락커'
  quantity INTEGER NOT NULL DEFAULT 1,
  unit_price INTEGER NOT NULL, -- 원 단위
  total_amount INTEGER NOT NULL, -- 원 단위
  specifications TEXT, -- JSON 형태 추가 정보
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (payment_id) REFERENCES payments(id) ON DELETE CASCADE
);
```

#### 3. PT_SESSIONS 테이블 개선 ⚠️ **기존 테이블 수정**

```sql
-- 기존 pt_sessions 테이블 구조 개선
ALTER TABLE pt_sessions ADD COLUMN total_sessions INTEGER; -- 총 구매 횟수
ALTER TABLE pt_sessions ADD COLUMN used_sessions INTEGER DEFAULT 0; -- 사용한 횟수
ALTER TABLE pt_sessions ADD COLUMN remaining_sessions INTEGER; -- 남은 횟수
ALTER TABLE pt_sessions ADD COLUMN package_expiry_date DATE; -- 패키지 만료일
ALTER TABLE pt_sessions ADD COLUMN package_status TEXT DEFAULT 'active'; -- 'active', 'expired', 'cancelled'

-- 기존 세션별 기록은 유지하면서 패키지 관리 기능 추가
```

#### 4. LOCKER_ASSIGNMENTS 테이블 신규 생성 ⭐

```sql
CREATE TABLE IF NOT EXISTS locker_assignments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  member_id INTEGER NOT NULL,
  payment_id INTEGER NOT NULL,
  locker_number TEXT NOT NULL,
  locker_type TEXT DEFAULT 'individual', -- 'individual', 'couple'
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  monthly_fee INTEGER NOT NULL, -- 원 단위
  status TEXT DEFAULT 'active', -- 'active', 'expired', 'cancelled'
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (member_id) REFERENCES members(id),
  FOREIGN KEY (payment_id) REFERENCES payments(id),
  UNIQUE(locker_number, start_date) -- 동일 락커의 중복 배정 방지
);
```

#### 5. REFUNDS 테이블 신규 생성 ⭐

```sql
CREATE TABLE IF NOT EXISTS refunds (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  payment_id INTEGER NOT NULL,
  requested_by INTEGER NOT NULL, -- staff.id
  approved_by INTEGER, -- staff.id
  refund_amount INTEGER NOT NULL, -- 원 단위
  reason TEXT NOT NULL,
  refund_method TEXT NOT NULL, -- 'account_transfer', 'card_cancel', 'cash'
  account_info TEXT, -- 환불 계좌 정보 (암호화 저장)
  status TEXT NOT NULL DEFAULT 'pending', -- 'pending', 'approved', 'rejected', 'processed'
  requested_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  approved_at DATETIME,
  processed_at DATETIME,
  notes TEXT,

  FOREIGN KEY (payment_id) REFERENCES payments(id),
  FOREIGN KEY (requested_by) REFERENCES staff(id),
  FOREIGN KEY (approved_by) REFERENCES staff(id)
);
```

#### 6. PAYMENT_HISTORY 테이블 신규 생성 ⭐

```sql
CREATE TABLE IF NOT EXISTS payment_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  payment_id INTEGER NOT NULL,
  action TEXT NOT NULL, -- 'created', 'updated', 'refund_requested', 'refunded', 'cancelled'
  old_value TEXT, -- JSON 형태로 이전 값
  new_value TEXT, -- JSON 형태로 새 값
  performed_by INTEGER NOT NULL, -- staff.id
  notes TEXT,
  ip_address TEXT, -- 보안 추적용
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (payment_id) REFERENCES payments(id),
  FOREIGN KEY (performed_by) REFERENCES staff(id)
);
```

### 🔗 **데이터 연동 및 무결성 보장**

#### ✅ **회원-직원-결제 연동 매트릭스**

| 테이블             | members 연동 | staff 연동                         | payments 연동 | 용도           |
| ------------------ | ------------ | ---------------------------------- | ------------- | -------------- |
| payments           | ✅ member_id | ✅ staff_id                        | -             | 기본 결제 정보 |
| payment_items      | 간접 연동    | 간접 연동                          | ✅ payment_id | 결제 상세 항목 |
| pt_sessions        | ✅ member_id | ✅ trainer_id                      | ✅ payment_id | 피티 횟수 관리 |
| locker_assignments | ✅ member_id | 간접 연동                          | ✅ payment_id | 락커 배정 관리 |
| refunds            | 간접 연동    | ✅ requested_by<br/>✅ approved_by | ✅ payment_id | 환불 처리      |

#### 🛡️ **데이터 무결성 제약조건**

```sql
-- 중요한 인덱스 생성
CREATE INDEX IF NOT EXISTS idx_payments_member_staff ON payments(member_id, staff_id);
CREATE INDEX IF NOT EXISTS idx_payments_date_type ON payments(payment_date, payment_type);
CREATE INDEX IF NOT EXISTS idx_payment_items_payment ON payment_items(payment_id);
CREATE INDEX IF NOT EXISTS idx_pt_sessions_member ON pt_sessions(member_id);
CREATE INDEX IF NOT EXISTS idx_pt_sessions_trainer ON pt_sessions(trainer_id);
CREATE INDEX IF NOT EXISTS idx_locker_assignments_member ON locker_assignments(member_id);
CREATE INDEX IF NOT EXISTS idx_locker_assignments_active ON locker_assignments(status);
CREATE INDEX IF NOT EXISTS idx_refunds_status ON refunds(status);
CREATE INDEX IF NOT EXISTS idx_payment_history_payment ON payment_history(payment_id);

-- 트리거 생성 (데이터 일관성 보장)
CREATE TRIGGER IF NOT EXISTS update_pt_remaining_sessions
AFTER UPDATE OF used_sessions ON pt_sessions
BEGIN
  UPDATE pt_sessions
  SET remaining_sessions = total_sessions - NEW.used_sessions
  WHERE id = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS log_payment_changes
AFTER UPDATE ON payments
BEGIN
  INSERT INTO payment_history (payment_id, action, old_value, new_value, performed_by)
  VALUES (NEW.id, 'updated',
    json_object('status', OLD.status, 'amount', OLD.amount),
    json_object('status', NEW.status, 'amount', NEW.amount),
    NEW.staff_id);
END;
```

## 🎨 UI 컴포넌트 상세 명세

### 📝 1. PaymentForm (결제 등록 폼)

**위치:** `src/components/payment/PaymentForm.tsx`

**UI 구성요소:**

- **회원 선택:** members 테이블 연동 검색 (member_number, name, phone)
- **담당 직원:** staff 테이블에서 can_manage_payments=1인 직원만 표시
- **결제 유형 선택:** 라디오 버튼 (membership/pt/locker)
- **상품 선택:**
  - 회원권: membership_types 테이블 연동 (1/3/12개월)
  - 피티: pt_packages 테이블 연동 (5/10/20회) + trainer 선택
  - 락커: 고정 월 요금 + locker_number 입력
- **금액 계산:** 자동 계산 + 수동 조정 가능 (원 단위)
- **결제 방식:** 기존 제약조건 확장 ('현금', '카드', '계좌이체', '온라인결제')
- **만료일:** payment_type별 자동 계산 (수정 가능)
- **메모:** payments.notes 저장

**데이터 연동 로직:**

- members.assigned_staff_id 기본값으로 담당 직원 설정
- payment_items 테이블에 상세 항목 자동 생성
- pt 결제시 pt_sessions 테이블에 패키지 정보 생성
- locker 결제시 locker_assignments 테이블에 배정 정보 생성

**유효성 검사:**

- 회원 선택 필수 (members.active = 1)
- 담당 직원 권한 확인 (staff.can_manage_payments = 1)
- 금액 0원 이상, 천만원 이하
- 락커 중복 배정 방지

### 📋 2. PaymentTable (결제 목록)

**위치:** `src/components/payment/PaymentTable.tsx`

**컬럼 구성:**

- 결제일시
- 회원명 (클릭 시 상세보기)
- 결제 유형 (회원권/피티/락커)
- 상품명 (1개월권, 10회 피티 등)
- 금액 (천 단위 콤마)
- 결제 방식
- 담당 직원
- 상태 (완료/환불/취소)
- 액션 (상세보기/환불)

**기능:**

- 페이지네이션 (기본 20개)
- 정렬 (날짜, 금액, 회원명)
- 필터링 (기간, 유형, 직원, 상태)

### 📊 3. PaymentStats (통계 대시보드)

**위치:** `src/components/payment/PaymentStats.tsx`

**통계 카드들:**

- **오늘 매출:** 금액 + 건수
- **이번 달 매출:** 금액 + 전월 대비
- **피티 잔여 현황:** 전체 잔여 횟수
- **만료 예정:** 3일 이내 만료 건수

**차트:**

- 월별 매출 트렌드 (라인 차트)
- 결제 유형별 비율 (도넛 차트)
- 직원별 매출 순위 (바 차트)

### 🔍 4. PaymentSearchFilter (검색 필터)

**위치:** `src/components/payment/PaymentSearchFilter.tsx`

**검색 옵션:**

- **기간 설정:** 시작일/종료일 (기본: 최근 1개월)
- **회원 검색:** 이름/전화번호
- **결제 유형:** 전체/회원권/피티/락커
- **결제 방식:** 전체/현금/카드/계좌이체/온라인
- **담당 직원:** 드롭다운
- **상태:** 전체/완료/환불/취소

### 🔍 5. PaymentDetailModal (결제 상세보기)

**위치:** `src/components/payment/PaymentDetailModal.tsx`

**정보 섹션:**

- **기본 정보:** 결제 ID, 일시, 상태
- **회원 정보:** 이름, 전화번호, 담당 직원
- **결제 내역:** 상품명, 수량, 단가, 총 금액
- **피티 정보:** (피티 결제 시) 총 횟수, 사용/잔여 횟수, 트레이너
- **결제 방식:** 현금/카드 등
- **이력:** 결제/수정/환불 이력

**액션 버튼:**

- 환불 처리 (관리자만)
- 수정하기
- 영수증 출력

### 💸 6. RefundModal (환불 처리)

**위치:** `src/components/payment/RefundModal.tsx`

**입력 필드:**

- **환불 금액:** 최대 결제 금액까지
- **환불 사유:** 텍스트 입력 (필수)
- **환불 방식:** 계좌이체/카드 취소
- **승인자 확인:** 관리자 비밀번호/PIN

**계산 표시:**

- 원 결제 금액
- 환불 금액
- 수수료 (있는 경우)
- 실 환불 금액

## 🎯 1순위 구현 범위 (MVP)

### ✅ **1단계: 기본 결제 시스템** (2-3일)

**데이터베이스:**

- payments 테이블 확장 (locker_type, expiry_date, auto_renewal)
- payment_items 테이블 신규 생성
- 기본 인덱스 생성

**백엔드 API:**

- 결제 등록/조회/수정 (현금만)
- 회원권/피티/락커 결제 지원
- members/staff 테이블 연동

**프론트엔드:**

- PaymentForm 컴포넌트 (기존 MemberForm 패턴)
- PaymentTable 컴포넌트 (기존 MemberTable 패턴)
- 기본 CRUD 기능

### ✅ **2단계: 피티 횟수 관리** (1-2일)

**데이터베이스:**

- pt_sessions 테이블 개선 (total/used/remaining sessions)
- locker_assignments 테이블 신규 생성

**기능:**

- 피티 패키지 구매시 자동 횟수 생성
- 락커 배정 관리
- 만료일 자동 계산

### ✅ **3단계: 환불 시스템** (2-3일)

**데이터베이스:**

- refunds 테이블 신규 생성
- payment_history 테이블 신규 생성

**기능:**

- 환불 신청/승인 프로세스 (관리자만)
- 환불 이력 추적
- 데이터 무결성 보장

### ✅ **4단계: 기본 통계 및 연동** (1-2일)

**통계:**

- PaymentStats 컴포넌트
- 일별/월별 매출 현황
- 직원별 실적

**시스템 연동:**

- Payment.tsx 메인 페이지
- 네비게이션 메뉴 추가
- 기존 시스템과 완전 통합

## 단계별 구현 프롬프트

### 1단계: 분석 및 설계 🔍

```markdown
**프롬프트:** 기존 회원관리와 직원관리 시스템을 분석하여 결제관리 시스템을
설계하고 싶습니다.

다음을 순서대로 진행해주세요:

1. 현재 Member, Staff 관련 파일들의 구조와 패턴 분석
2. 결제관리에 필요한 기능 식별 ([요구사항 분석] 참조)
3. 데이터베이스 스키마 설계안 제시
4. 타입 정의 구조 설계안 제시

**주의사항:**

- 기존 코드 패턴을 최대한 유지
- SQLite 호환성 고려
- TypeScript 타입 안전성 확보
- 확장 가능한 구조로 설계
- 금융 데이터 정확성 보장

먼저 분석 결과만 보여주시고, 승인 후 다음 단계로 진행하겠습니다.
```

### 2단계: 데이터베이스 스키마 구현 🗃️

```markdown
**프롬프트:** 결제관리를 위한 데이터베이스 스키마를 구현해주세요.

**요구사항:**

- payments 테이블 확장 (락커 결제 지원 컬럼 추가) ⚠️ 기존 수정
- payment_items 테이블 생성 (결제 항목 상세) ⭐ 신규
- pt_sessions 테이블 개선 (패키지 관리 컬럼 추가) ⚠️ 기존 수정
- locker_assignments 테이블 생성 (락커 배정 관리) ⭐ 신규
- refunds 테이블 생성 (환불 관리) ⭐ 신규
- payment_history 테이블 생성 (결제 이력 추적) ⭐ 신규

**중요한 제약사항:**

- SQLite에서 지원하지 않는 문법 사용 금지
- 금융 데이터 무결성 보장 (원 단위 정수 저장)
- 외래키 관계 설정 (members, staff와 연동)
- 트랜잭션 안전성 확보
- 피티 횟수 관리 시스템 포함

**진행 방식:**

1. 마이그레이션 파일만 먼저 작성
2. 구문 검증 및 테스트
3. 문제없으면 다음 단계 진행

마이그레이션 파일 하나만 작성해주세요.
```

### 3단계: 타입 정의 구현 📝

```markdown
**프롬프트:** 결제관리를 위한 TypeScript 타입 정의를 구현해주세요.

**기본 요구사항:**

- Payment 인터페이스 (메인 결제 정보)
- PaymentItem 인터페이스 (결제 항목 상세)
- PaymentMethod, PaymentStatus 열거형
- RefundRequest, RefundInfo 인터페이스
- 검색/필터/정렬용 인터페이스들

**타입 안전성 규칙:**

- 금액 관련 필드는 number 타입으로 통일
- optional(?)과 required 필드 명확히 구분
- union 타입과 undefined 처리 고려
- 기존 Member, Staff 타입과 일관성 유지
- import/export 경로 정확히 지정

**진행 방식:**

1. src/types/payment.ts 파일만 작성
2. 기존 타입 파일과의 호환성 확인
3. TypeScript 컴파일 테스트
4. 문제없으면 다음 단계 진행

타입 정의 파일만 먼저 완성해주세요.
```

### 4단계: 백엔드 API 구현 ⚙️

```markdown
**프롬프트:** 결제관리를 위한 IPC 핸들러를 구현해주세요.

**구현 범위:**

- 결제 CRUD 작업 (생성, 조회, 수정, 취소)
- 결제 검색 및 필터링
- 결제 통계 조회
- 환불 처리 및 이력 관리
- 결제 방식별 통계

**기존 패턴 참조:**

- memberHandlers.ts, staffHandlers.ts의 구조와 패턴을 정확히 따라 구현
- 동일한 에러 처리 방식 사용
- 페이지네이션 지원
- 트랜잭션 처리 (특히 환불 시)

**진행 방식:**

1. src/main/ipc/paymentHandlers.ts 파일만 작성
2. main.ts와 preload.ts에 핸들러 등록
3. 기본 API 테스트
4. 문제없으면 다음 단계 진행

백엔드 핸들러만 먼저 구현해주세요.
```

### 5단계: 기본 컴포넌트 구현 🧩

```markdown
**프롬프트:** 결제관리의 기본 컴포넌트를 하나씩 구현해주세요.

**구현 순서 (하나씩):**

1. PaymentForm (결제 등록/수정 폼)
2. PaymentTable (결제 목록 테이블)
3. PaymentStats (결제 통계 대시보드)
4. PaymentSearchFilter (검색 및 필터)
5. PaymentDetailModal (결제 상세보기)
6. RefundModal (환불 처리 모달)

**각 컴포넌트 요구사항:**

- 기존 Member, Staff 컴포넌트와 동일한 UI/UX 패턴
- TypeScript 타입 안전성 확보
- 에러 처리 및 로딩 상태 관리
- 반응형 디자인 적용
- 금액 표시 포맷팅 적용

**진행 방식:** 첫 번째로 PaymentForm 컴포넌트만 구현해주세요.

- 결제 방식 선택 기능 포함
- 금액 입력 및 검증 로직
- 회원/직원 연동 선택기

컴파일 및 기본 테스트 후 다음 컴포넌트로 진행하겠습니다.
```

### 6단계: 메인 페이지 통합 🏠

```markdown
**프롬프트:** 결제관리 메인 페이지를 구현하고 전체 시스템과 통합해주세요.

**구현 내용:**

- Payment.tsx 메인 페이지 구성
- 모든 컴포넌트 통합 및 상태 관리
- 네비게이션 메뉴 추가
- 라우팅 설정

**통합 요구사항:**

- 기존 Members.tsx, Staff.tsx와 동일한 구조
- 토스트 알림 시스템 연동
- 에러 경계 처리
- 성능 최적화
- 실시간 통계 업데이트

**진행 방식:**

1. 페이지 구성 및 컴포넌트 연결
2. 네비게이션 및 라우팅 설정
3. 전체 기능 테스트
4. 회원-직원-결제 연동 기능 구현

단계별로 검증하면서 진행해주세요.
```

### 7단계: 고급 기능 구현 ⚡

```markdown
**프롬프트:** 결제관리의 고급 기능들을 구현해주세요.

**구현 기능:**

1. 환불 관리 시스템 (RefundManagementModal)
2. 할부 결제 지원 기능
3. 자동 결제 설정 (준비 단계)
4. 매출 리포트 및 통계
5. 결제 알림 시스템

**각 기능별 요구사항:**

- 환불 시 이력 자동 저장 및 승인 프로세스
- 할부 스케줄 관리 및 알림
- 권한 기반 접근 제어
- 데이터 무결성 보장
- 실시간 통계 갱신

**진행 방식:** 한 번에 하나씩 구현하고 테스트해주세요. 먼저 환불 관리 시스템부터
구현하겠습니다.
```

## 오류 방지 체크리스트

### ✅ 프롬프트 작성 전 확인사항

- [ ] 단계적 진행 방식으로 작성했는가?
- [ ] 기존 코드 패턴 참조를 명시했는가?
- [ ] SQLite 호환성을 고려했는가?
- [ ] TypeScript 타입 안전성을 강조했는가?
- [ ] 금융 데이터 처리 정확성을 고려했는가?
- [ ] 각 단계별 검증 포인트를 포함했는가?

### ✅ 구현 중 확인사항

- [ ] 컴파일 오류가 없는가?
- [ ] 기존 기능에 영향을 주지 않는가?
- [ ] 데이터베이스 스키마가 올바르게 적용되었는가?
- [ ] 타입 정의가 일관성 있게 작성되었는가?
- [ ] 에러 처리가 적절히 구현되었는가?
- [ ] 금액 계산이 정확한가? (소수점 처리)

### ✅ 테스트 확인사항

- [ ] `npm run type-check` 통과
- [ ] `npm run lint` 통과
- [ ] 데이터베이스 마이그레이션 성공
- [ ] 기본 CRUD 작업 동작
- [ ] UI 컴포넌트 정상 렌더링
- [ ] 금액 계산 정확성 검증

## 문제 해결 가이드

### 🚨 일반적인 오류와 해결책

#### 1. 기존 시스템과의 ID 타입 호환성

```sql
-- ❌ 잘못된 예 (기존 시스템과 타입 불일치)
CREATE TABLE refunds (
    id TEXT PRIMARY KEY,
    payment_id TEXT REFERENCES payments(id)
);

-- ✅ 올바른 예 (기존 시스템과 호환)
CREATE TABLE refunds (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    payment_id INTEGER REFERENCES payments(id)
);
```

#### 2. TypeScript 기존 타입과의 호환성

```typescript
// ❌ 잘못된 예 (기존 타입과 불일치)
interface Payment {
  id: string;
  member_id: string;
  staff_id: string;
}

// ✅ 올바른 예 (기존 Member, Staff 타입과 호환)
interface Payment {
  id: number;
  member_id: number;
  staff_id: number;
  amount: number; // DECIMAL(10,2) → 원 단위 정수로 변환
}
```

#### 3. 환불 처리 트랜잭션

```typescript
// ✅ 올바른 예 - 트랜잭션으로 안전하게 처리
async function processRefund(paymentId: string, refundAmount: number) {
  const transaction = database.transaction(() => {
    // 1. 원본 결제 확인
    // 2. 환불 기록 생성
    // 3. 결제 상태 업데이트
    // 4. 이력 저장
  });

  return transaction();
}
```

#### 4. 컴포넌트 금액 표시

```typescript
// ✅ 올바른 예 - 일관된 포맷팅
const formatCurrency = (amount: number): string => {
  return amount.toLocaleString('ko-KR', {
    style: 'currency',
    currency: 'KRW',
  });
};
```

### 🔧 디버깅 명령어

```bash
# 타입 체크
npm run type-check

# 린트 검사
npm run lint

# 전체 진단
npm run doctor

# 개발 서버 실행
npm run dev

# 데이터베이스 검증
npm run db:check
```

### 📞 추가 도움이 필요할 때

문제가 지속되면 다음 정보와 함께 질문하세요:

1. 정확한 에러 메시지
2. 실행한 명령어
3. 수정하려던 파일
4. 예상한 동작과 실제 동작
5. 금액 관련 오류의 경우 계산 과정

---

## 📝 사용법

1. **요구사항 분석** 섹션을 먼저 작성 완료
2. 위 프롬프트를 순서대로 복사해서 사용
3. 각 단계 완료 후 검증하고 다음 단계 진행
4. 문제 발생시 체크리스트와 해결 가이드 참조
5. 필요시 프롬프트를 프로젝트에 맞게 조정

**성공적인 구현을 위해 단계를 건너뛰지 마세요!** 🎯

## 🔍 **데이터 연동성 최종 검증**

### ✅ **필수 확인 사항**

#### 1. **기존 시스템 호환성**

- [ ] ID 타입 일치: INTEGER PRIMARY KEY AUTOINCREMENT
- [ ] 외래키 관계: members(id), staff(id) 정확히 참조
- [ ] 컬럼명 일치: member_id, staff_id (INTEGER 타입)
- [ ] 제약조건 호환: CHECK 구문 기존 값 포함

#### 2. **데이터 무결성**

- [ ] 트랜잭션 처리: 결제-항목-세션 동시 생성
- [ ] 참조 무결성: ON DELETE CASCADE 설정
- [ ] 중복 방지: 락커 배정, 결제 번호 UNIQUE
- [ ] 날짜 검증: 만료일 > 시작일, 과거 날짜 방지

#### 3. **성능 최적화**

- [ ] 인덱스 생성: 자주 조회되는 컬럼들
- [ ] 쿼리 최적화: JOIN 성능 고려
- [ ] 페이지네이션: 대용량 데이터 처리
- [ ] 캐싱 전략: 자주 사용되는 설정값들

#### 4. **보안 및 권한**

- [ ] 권한 확인: staff.can_manage_payments 검증
- [ ] 데이터 암호화: 환불 계좌 정보
- [ ] 감사 추적: payment_history 모든 변경 로깅
- [ ] SQL 인젝션 방지: 준비된 구문 사용

### 🚨 **구현 전 필수 체크**

```sql
-- 기존 시스템 연동 확인 쿼리
SELECT
  m.name as member_name,
  s.name as staff_name,
  p.amount,
  p.payment_type
FROM payments p
JOIN members m ON p.member_id = m.id
JOIN staff s ON p.staff_id = s.id
WHERE p.payment_date >= date('now', '-1 month')
LIMIT 5;
```

**이 쿼리가 오류 없이 실행되면 연동 준비 완료!** ✅

---

**특히 금융 데이터는 정확성이 생명입니다!** 💰  
**기존 시스템과의 완벽한 호환성을 보장해야 합니다!** 🔗
