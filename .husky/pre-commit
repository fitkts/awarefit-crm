#!/usr/bin/env sh

echo "π” [Pre-commit] μ»¤λ°‹ μ „ μλ™ κ²€μ¦ μ‹μ‘..."

# 1. TypeScript νƒ€μ… μ²΄ν¬
echo "π”§ [Pre-commit] TypeScript νƒ€μ… μ²΄ν¬ μ¤‘..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "β [Pre-commit] TypeScript νƒ€μ… μ¤λ¥κ°€ μμµλ‹λ‹¤. μμ • ν›„ λ‹¤μ‹ μ»¤λ°‹ν•μ„Έμ”."
  exit 1
fi

# 2. ESLint κ²€μ‚¬
echo "π”§ [Pre-commit] ESLint κ²€μ‚¬ μ¤‘..."
npm run lint
if [ $? -ne 0 ]; then
  echo "β [Pre-commit] ESLint μ¤λ¥κ°€ μμµλ‹λ‹¤. μμ • ν›„ λ‹¤μ‹ μ»¤λ°‹ν•μ„Έμ”."
  exit 1
fi

# 3. SQL ν•Έλ“¤λ¬ νμΌ λ³€κ²½ μ‹ νΉλ³„ κ²€μ¦
echo "π”§ [Pre-commit] λ³€κ²½λ νμΌ κ²€μ‚¬ μ¤‘..."
SQL_HANDLERS=$(git diff --cached --name-only | grep -E "(ipc/.*Handlers\.ts|queryBuilder\.ts|dbLogger\.ts)" || true)

if [ ! -z "$SQL_HANDLERS" ]; then
  echo "οΏ½οΏ½οΈ [Pre-commit] SQL κ΄€λ ¨ νμΌ λ³€κ²½ κ°μ§€ - νΉλ³„ κ²€μ¦ μν–‰ μ¤‘..."
  
  # SQL κ΄€λ ¨ νμΌ λ³€κ²½ μ‹ μ¶”κ°€ κ²€μ¦
  for file in $SQL_HANDLERS; do
    echo "  π” κ²€μ‚¬ μ¤‘: $file"
    
    # db.prepare μ‚¬μ© μ‹ νλΌλ―Έν„° κ²€μ¦ λ΅μ§ ν™•μΈ
    if git diff --cached "$file" | grep -q "db\.prepare" && ! git diff --cached "$file" | grep -q "params\.length"; then
      echo "  β οΈ κ²½κ³ : $fileμ—μ„ db.prepare() μ‚¬μ© μ‹ νλΌλ―Έν„° κ²€μ¦ λ΅μ§μ΄ μ—†μµλ‹λ‹¤."
      echo "  π’΅ QueryBuilder λλ” dbLogger μ‚¬μ©μ„ κ¶μ¥ν•©λ‹λ‹¤."
    fi
    
    # COUNT μΏΌλ¦¬ μ‚¬μ© μ‹ μ£Όμμ‚¬ν•­ μ•λ¦Ό
    if git diff --cached "$file" | grep -qi "count("; then
      echo "  β οΈ μ£Όμ: $fileμ—μ„ COUNT μΏΌλ¦¬ μ‚¬μ©λ¨. νμ΄μ§€λ„¤μ΄μ… νλΌλ―Έν„° μ²λ¦¬ ν™•μΈ ν•„μ”."
    fi
  done
  
  echo "β… [Pre-commit] SQL κ΄€λ ¨ νμΌ κ²€μ¦ μ™„λ£"
fi

# 4. ν…μ¤νΈ νμΌ μ—…λ°μ΄νΈ ν™•μΈ - λΉ„ν™μ„±ν™”
echo "β­οΈ [Pre-commit] ν…μ¤νΈ μ—…λ°μ΄νΈ κ°•μ  κ²€μ‚¬ λΉ„ν™μ„±ν™”λ¨ (CIμ—μ„ ν™•μΈ)"

# 5. μλ™ μ²΄ν¬λ¦¬μ¤νΈ μƒμ„±
echo "π“‹ [Pre-commit] μλ™ μ²΄ν¬λ¦¬μ¤νΈ μƒμ„± μ¤‘..."
node scripts/auto-checklist.js

# 6. μµμΆ… ν™•μΈ
echo "β… [Pre-commit] λ¨λ“  κ²€μ¦μ΄ μ™„λ£λμ—μµλ‹λ‹¤!"
echo "π“‹ CHECKLIST.md νμΌμ΄ μƒμ„±λμ—μµλ‹λ‹¤. μ¶”κ°€ κ²€μ¦ μ‚¬ν•­μ„ ν™•μΈν•μ„Έμ”."

exit 0
