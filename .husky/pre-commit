#!/usr/bin/env sh

echo "🔍 [Pre-commit] 커밋 전 자동 검증 시작..."

# 1. TypeScript 타입 체크
echo "🔧 [Pre-commit] TypeScript 타입 체크 중..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "❌ [Pre-commit] TypeScript 타입 오류가 있습니다. 수정 후 다시 커밋하세요."
  exit 1
fi

# 2. ESLint 검사
echo "🔧 [Pre-commit] ESLint 검사 중..."
npm run lint
if [ $? -ne 0 ]; then
  echo "❌ [Pre-commit] ESLint 오류가 있습니다. 수정 후 다시 커밋하세요."
  exit 1
fi

# 3. SQL 핸들러 파일 변경 시 특별 검증
echo "🔧 [Pre-commit] 변경된 파일 검사 중..."
SQL_HANDLERS=$(git diff --cached --name-only | grep -E "(ipc/.*Handlers\.ts|queryBuilder\.ts|dbLogger\.ts)" || true)

if [ ! -z "$SQL_HANDLERS" ]; then
  echo "��️ [Pre-commit] SQL 관련 파일 변경 감지 - 특별 검증 수행 중..."
  
  # SQL 관련 파일 변경 시 추가 검증
  for file in $SQL_HANDLERS; do
    echo "  🔍 검사 중: $file"
    
    # db.prepare 사용 시 파라미터 검증 로직 확인
    if git diff --cached "$file" | grep -q "db\.prepare" && ! git diff --cached "$file" | grep -q "params\.length"; then
      echo "  ⚠️ 경고: $file에서 db.prepare() 사용 시 파라미터 검증 로직이 없습니다."
      echo "  💡 QueryBuilder 또는 dbLogger 사용을 권장합니다."
    fi
    
    # COUNT 쿼리 사용 시 주의사항 알림
    if git diff --cached "$file" | grep -qi "count("; then
      echo "  ⚠️ 주의: $file에서 COUNT 쿼리 사용됨. 페이지네이션 파라미터 처리 확인 필요."
    fi
  done
  
  echo "✅ [Pre-commit] SQL 관련 파일 검증 완료"
fi

# 4. 테스트 파일 업데이트 확인
echo "🔧 [Pre-commit] 테스트 파일 업데이트 확인 중..."
CHANGED_SRC_FILES=$(git diff --cached --name-only | grep -E "^src/.*\.(ts|tsx)$" | grep -v "__tests__" | grep -v "\.spec\." | grep -v "\.test\." || true)
CHANGED_TEST_FILES=$(git diff --cached --name-only | grep -E "(e2e/|__tests__/|\.spec\.|\.test\.)" || true)

if [ ! -z "$CHANGED_SRC_FILES" ] && [ -z "$CHANGED_TEST_FILES" ]; then
  echo "⚠️ [Pre-commit] 소스 코드가 변경되었지만 테스트 파일이 업데이트되지 않았습니다."
  echo "💡 다음 중 하나를 수행하는 것을 권장합니다:"
  echo "  1. 관련 E2E 테스트 케이스 추가/수정"
  echo "  2. 단위 테스트 업데이트"
  echo "  3. 테스트가 불필요한 변경사항인지 검토"
  echo ""
  echo "🤔 계속 진행하시겠습니까? (y/N)"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    echo "❌ [Pre-commit] 커밋이 취소되었습니다."
    exit 1
  fi
fi

# 5. 자동 체크리스트 생성
echo "📋 [Pre-commit] 자동 체크리스트 생성 중..."
node scripts/auto-checklist.js

# 6. 최종 확인
echo "✅ [Pre-commit] 모든 검증이 완료되었습니다!"
echo "📋 CHECKLIST.md 파일이 생성되었습니다. 추가 검증 사항을 확인하세요."

exit 0
